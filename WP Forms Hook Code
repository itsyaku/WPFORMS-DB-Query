// Hook to process after WPForms submission
add_action( 'wpforms_process_complete', 'send_email_to_matching_dealerships', 10, 4 );
function send_email_to_matching_dealerships( $fields, $entry, $form_data, $entry_id ) {
    // Define the form IDs
    $customer_form_id = 437; // Customer Form ID
    $dealership_form_id = 235; // Dealerships Form ID

    // Check if the form is the Customer Form
    if ( $form_data['id'] == $customer_form_id ) {

        // Extract the user input from the Customer Form fields
        $customer_name = $fields[28]['value']; // Customer Name field in Customer Form
        $customer_email = $fields[3]['value']; // Customer Email field in Customer Form
        $customer_phone = $fields[2]['value']; // Phone Number field in Customer Form
        $customer_location = $fields[27]['value']; // Location field in Customer Form
        $customer_manufacturer = $fields[25]['value']; // Manufacturer field in Customer Form
        $customer_specificvehicle = $fields[5]['value']; // If the customer want a specific model
        $customer_pricerange = $fields[26]['value']; // Customer Price Range
        $customer_contactmethod = $fields[17]['value']; // Preferred Contact Method
        $customer_financeoptions = $fields[6]['value']; // Finance Options
        $customer_suggestions = $fields[21]['value']; // Is the customer open to suggestions
        $customer_message = $fields[10]['value']; // Additional Information if needed
        $customer_consent = $fields[11]['value']; // Customer consent to the terms of submitting their data

				// *** Logging the captured form data ***
				        error_log('Customer Manufacturer: ' . $customer_manufacturer);
				        error_log('Customer Location: ' . $customer_location);

				global $wpdb;

        // Debugging: Log when the function is triggered
        error_log('send_email_to_matching_dealerships triggered');
        error_log('Customer Manufacturer: ' . $customer_manufacturer);
        error_log('Customer Location: ' . $customer_location);

        // Query the database to find matching Dealership entries
        $query = "
            SELECT e.entry_id, f.value as dealership_email
            FROM {$wpdb->prefix}wpforms_entries e
            JOIN {$wpdb->prefix}wpforms_entry_fields f ON e.entry_id = f.entry_id
            WHERE e.form_id = %d
            AND ( f.field_id = 7 AND f.value = %s )  /* Manufacturer in Dealerships Form */
            AND ( f.field_id = 4 AND f.value = %s )  /* Location in Dealerships Form */";

        // Prepare and execute the query with Manufacturer and Location fields
        $results = $wpdb->get_results( $wpdb->prepare( $query, $dealership_form_id, $customer_manufacturer, $customer_location ) );

        // Debugging: Log the query and the number of results found
        error_log('SQL Query: ' . $wpdb->last_query);
        error_log('Number of matching dealerships: ' . count($results));

        // Loop through the results and send an email to each matching dealership
        if ( $results ) {
            foreach ( $results as $dealership ) {
                // Debugging: Log each dealership email before sending
                error_log('Sending email to: ' . $dealership->dealership_email);

                // Prepare email details
                $to = $dealership->dealership_email;
                $subject = 'Incoming Lead from SpotMyRide';
                $message = 'A new customer inquiry matches your dealership\'s criteria. Here are the details:';
                // Add details from the Customer Form
                $message .= "\nCustomer Name: " . $customer_name;
                $message .= "\nCustomer Email: " . $customer_email;
                $message .= "\nPhone Number: " . $customer_phone;
                $message .= "\nLocation: " . $customer_location;
                $message .= "\nManufacturer: " . $customer_manufacturer;
                $message .= "\nSpecific Model: " . $customer_specificvehicle;
                $message .= "\nPrice Range: " . $customer_pricerange;
                $message .= "\nPreferred Contact Method: " . $customer_contactmethod;
                $message .= "\nFinancing Options: " . $customer_financeoptions;
                $message .= "\nCustomer Open to other Suggestions: " . $customer_suggestions;
                $message .= "\nAdditional Information: " . $customer_message;
                $message .= "\nConsent: " . $customer_message;
                $headers = array('Content-Type: text/html; charset=UTF-8');

                // Send email to the dealership
                if ( ! wp_mail( $to, $subject, $message, $headers ) ) {
                    error_log('Failed to send email to: ' . $to);
                } else {
                    error_log('Email sent successfully to: ' . $to);
                }
            }
        } else {
            error_log('No matching dealerships found.');
        }
    }
}
